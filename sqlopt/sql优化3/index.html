<!DOCTYPE html>
<html lang="en" >

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Hugo 0.55.6" />
    
    <link rel="canonical" href="https://github.com/mjczz/sqldoc/sqlopt/sql%E4%BC%98%E5%8C%963/" />
    <meta name="description" content="A hugo site using Edidor. &lt;br/&gt;&lt;br/&gt; Ctrl&#43;B toggle sidebar. ">
    

    <title>sql优化3 &middot; Edidor Demo</title>

    <link rel="shortcut icon" href="https://github.com/mjczz/sqldoc/images/favicon.ico" />

    <link rel="stylesheet" href="https://github.com/mjczz/sqldoc/css/main.css" />
    
        
        <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/atom-one-light.min.css">
        
    
    
    
</head>


<body class="loading light-mode">
    
<div class="top">
    <img class="logo" src="https://github.com/mjczz/sqldoc/images/logo.svg" alt="logo" />
</div>
<div class="bottom">
    <img class="logo" src="https://github.com/mjczz/sqldoc/images/logo.svg" alt="logo" />
</div>

    <header class="header">
    <ul class="menu clearfix control">
        

<li class="logo-container logo-default">
    <a href="https://github.com/mjczz/sqldoc/" class="btn logo-link">
        <img class="logo" src="https://github.com/mjczz/sqldoc/images/logo.svg" alt="logo" />
    </a>
</li>

        
        
        
        <li>
            <a href="/mjczz/sqldoc/" class="btn">
                首页
            </a>
        </li>
        
        
        
        <li>
            <a href="/mjczz/sqldoc/sqlopt" class="btn">
                sql优化
            </a>
        </li>
        
        
        
        <li>
            <a href="/mjczz/sqldoc/posts" class="btn">
                文章
            </a>
        </li>
        
        
        
        
        <li 
            class="">
            <a class="btn" id="theme-switcher-button">
                侧边栏
            </a>
            <ul class="sub-menu control">
                
                <li class="">
                    <a href="#"
                    
                        class="btn toggle-sidebar"
                    >切换</a>
                </li>
                
            </ul>
        </li>
        
        
        
        
        <li  id="theme-switcher" 
            class="">
            <a class="btn" id="theme-switcher-button">
                Theme
            </a>
            <ul class="sub-menu control">
                
                <li class="">
                    <a href="#"
                    
                        
                        data-theme="light" class="btn"
                        
                    >Light</a>
                </li>
                
                <li class="">
                    <a href="#"
                    
                        
                        data-theme="dark" class="btn"
                        
                    >Dark</a>
                </li>
                
                <li class="">
                    <a href="#"
                    
                        
                        data-theme="wild" class="btn"
                        
                    >Wild</a>
                </li>
                
                <li class="">
                    <a href="#"
                    
                        
                        class="export-wild btn"
                        
                    >Export Wild Style</a>
                </li>
                
            </ul>
        </li>
        
        
    </ul>
</header>

    <div class="middle">
        <nav class="sidebar">
            <ul class="posts control">
    
    <li><a class="no-break btn" href='/mjczz/sqldoc/sqlopt/sql%E4%BC%98%E5%8C%965/'><i class="icon icon-post"></i>sql优化5</a></li>
    
    <li><a class="no-break btn" href='/mjczz/sqldoc/sqlopt/sql%E4%BC%98%E5%8C%964/'><i class="icon icon-post"></i>sql优化4</a></li>
    
    <li><a class="no-break btn" href='/mjczz/sqldoc/sqlopt/sql%E4%BC%98%E5%8C%963/'><i class="icon icon-post"></i>sql优化3</a></li>
    
    <li><a class="no-break btn" href='/mjczz/sqldoc/sqlopt/sql%E4%BC%98%E5%8C%962/'><i class="icon icon-post"></i>sql优化2</a></li>
    
    <li><a class="no-break btn" href='/mjczz/sqldoc/sqlopt/sql%E4%BC%98%E5%8C%961/'><i class="icon icon-post"></i>sql优化1</a></li>
    
</ul>

        </nav>
        <main class="main">
            <article class="article">
    <h2 class="title"><a href='/mjczz/sqldoc/sqlopt/sql%E4%BC%98%E5%8C%963/' class="btn">sql优化3</a></h2>
    <div class="article-meta clearfix">
        <ul class="dates clearfix left control">
            <li><i class="icon icon-date"></i></li>
            <li class="publish-date">
                <time datetime="2019.06.04">2019.06.04</time>
            </li>
        </ul>
        
        
    </div>
    <div class="content">
        
        

<h3 id="业务场景">业务场景</h3>

<p>查询资源对应的跟进记录</p>

<h3 id="原sql">原sql</h3>

<pre><code class="language-sql">statement: SELECT * FROM &quot;nice_crm2_follow&quot;
WHERE &quot;student_id&quot; IN('74939', '282698', '282707', '282706', '282702', '282697', '282700', '282703', '282701', '282696', '282699', '282704', '282695', '282713', '282729', '282726', '282711', '282717', '282714', '282710', '282718', '282720', '282724', '282727', '282721', '282712', '282731', '282716', '282709', '282732', '282722', '282725', '282730', '282723', '282715', '282728', '282733', '282735', '282736', '282734', '282737', '282738', '282739', '282752', '282758', '282749', '282741', '282743', '282767', '282755', '282760', '282748', '282753', '282763', '282766', '282744', '282762', '282764', '282750', '282757', '282751', '282761', '282740', '282765', '282742', '282747', '282746', '282756', '282759', '282754', '282773', '282783', '282772', '282777', '282782', '282778', '282769', '282779', '282775', '282780', '282771', '282781', '282768', '282770', '282776', '282774', '282791', '38110', '22196', '80891', '80724', '87002', '21084', '61143', '50765', '50729', '50764', '50741', '80862', '50809', '61054', '80786', '70170', '34128', '65844', '65850', '66175', '65852', '65862')
</code></pre>

<h3 id="查询计划分析">查询计划分析</h3>

<pre><code class="language-sql">Seq Scan on nice_crm2_follow  (cost=0.00..225971.96 rows=1205 width=78) (actual time=54.252..1112.725 rows=5 loops=1)
  Filter: (student_id = ANY ('{74939,282698,282707,282706,282702,282697,282700,282703,282701,282696,282699,282704,282695,282713,282729,282726,282711,282717,282714,282710,282718,282720,282724,282727,282721,282712,282731,282716,282709,282732,282722,282725,282730,282723,282715,282728,282733,282735,282736,282734,282737,282738,282739,282752,282758,282749,282741,282743,282767,282755,282760,282748,282753,282763,282766,282744,282762,282764,282750,282757,282751,282761,282740,282765,282742,282747,282746,282756,282759,282754,282773,282783,282772,282777,282782,282778,282769,282779,282775,282780,282771,282781,282768,282770,282776,282774,282791,38110,22196,80891,80724,87002,21084,61143,50765,50729,50764,50741,33450,30175,30178,33453,66044,30720,30158,30157,30382,30359,30696,30684,30672,30671,30643,30033,30407,30127,29859,29851,29846,29815,29787,30733,30145,30089}'::integer[]))
  Rows Removed by Filter: 823441

Planning time: 0.574 ms
Execution time: 1112.757 ms
</code></pre>

<h3 id="分析">分析</h3>

<p>此sql目的是在查询资源信息后，查询对应资源的跟进记录。
可通过传入更多参数来提升查询性能。</p>

<h3 id="解决方案">解决方案</h3>

<p>在业务层代码家人city和campus参数即可。</p>

<h3 id="优化后的sql">优化后的sql</h3>

<pre><code class="language-sql">SELECT * FROM &quot;nice_crm2_follow&quot;
WHERE city = '7' and campus = '702' and
&quot;student_id&quot; IN('74939', '282698', '282707', '282706', '282702', '282697', '282700', '282703', '282701', '282696', '282699', '282704', '282695', '282713', '282729', '282726', '282711', '282717', '282714', '282710', '282718', '282720', '282724', '282727', '282721', '282712', '282731', '282716', '282709', '282732', '282722', '282725', '282730', '282723', '282715', '282728', '282733', '282735', '282736', '282734', '282737', '282738', '282739', '282752', '282758', '282749', '282741', '282743', '282767', '282755', '282760', '282748', '282753', '282763', '282766', '282744', '282762', '282764', '282750', '282757', '282751', '282761', '282740', '282765', '282742', '282747', '282746', '282756', '282759', '282754', '282773', '282783', '282772', '282777', '282782', '282778', '282769', '282779', '282775', '282780', '282771', '282781', '282768', '282770', '282776', '282774', '282791', '38110', '22196', '80891', '80724', '87002', '21084', '61143', '50765', '50729', '50764', '50741', '80862', '50809', '61054', '80786', '70170', '34128', '65844', '65850', '66175', '65852', '65862', '66183', '30432', '31016', '32667', '32669', '31019', '66204', '32665', '32659', '31923', '31922', '30076', '30065', '30052', '30051', '32652', '32647', '32684', '32508', '31273', '32514', '32562', '31277', '65896', '30439', '32101', '32691', '32705', '32866', '32728', '32754', '65915', '66124', '32767', '33243', '65937', '33299', '33322', '65953', '66126', '30442', '30509', '30776', '65956', '33385', '31872', '65991', '66127', '33269', '33272', '65993', '33284', '33402', '65994', '66136', '30444', '29692', '30758', '33405', '33415', '65997', '33433', '33438', '66027', '33490', '33450', '30175', '30178', '33453', '66044', '30720', '30158', '30157', '30382', '30359', '30696', '30684', '30672', '30671', '30643', '30033', '30407', '30127', '29859', '29851', '29846', '29815', '29787', '30733', '30145', '30089')
</code></pre>

<h3 id="优化后的sql查询计划分析">优化后的sql查询计划分析</h3>

<pre><code class="language-sql">Seq Scan on nice_crm2_follow  (cost=0.00..230089.19 rows=1 width=78) (actual time=10.224..196.501 rows=5 loops=1)
  Filter: ((city = 7) AND (campus = 702) AND (student_id = ANY ('{74939,282698,282707,282706,282702,282697,282700,282703,282701,282696,282699,282704,282695,282713,282729,282726,282711,282717,282714,282710,282718,282720,282724,282727,282721,282712,282731,282716,282709,282732,282722,282725,282730,282723,282715,282728,282733,282735,282736,282734,282737,282738,282739,282752,282758,282749,282741,282743,282767,282755,282760,282748,282753,282763,282766,282744,282762,282764,282750,282757,282751,282761,282740,282765,282742,282747,282746,282756,282759,282754,282773,282783,282772,282777,282782,282778,282769,282779,282775,282780,282771,282781,282768,282770,282776,282774,282791,38110,22196,80891,80724,87002,21084,61143,50765,50729,50764,50741,80862,50809,61054,80786,70170,34128,65844,65850,66175,65852,65862,66183,30432,31016,32667,32669,31019,66204,32665,32659,31923,31922,30076,30065,30052,30051,32652,32647,32684,32508,31273,32514,32562,31277,65896,30439,32101,32691,32705,32866,32728,32754,65915,66124,32767,33243,65937,33299,33322,65953,66126,30442,30509,30776,65956,33385,31872,65991,66127,33269,33272,65993,33284,33402,65994,66136,30444,29692,30758,33405,33415,65997,33433,33438,66027,33490,33450,30175,30178,33453,66044,30720,30158,30157,30382,30359,30696,30684,30672,30671,30643,30033,30407,30127,29859,29851,29846,29815,29787,30733,30145,30089}'::integer[])))
  Rows Removed by Filter: 823441
Planning time: 0.477 ms
Execution time: 196.534 ms
</code></pre>

        
    </div>

</article>
<section class="comment">
    <p class="local-info">
        Comment is disabled to avoid unwanted discussions from 'localhost:1313' on your Disqus
        account...
    </p>
    <div id="disqus_thread"></div>
</section>
<script type="text/javascript">

    (function () {
        if (window.location.hostname == "localhost") {
            return
        }
        document.querySelector('.local-info').classList.add('hide')

        let dsq = document.createElement('script')
        dsq.type = 'text/javascript'
        dsq.async = true
        let disqus_shortname = 'mjczz'
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq)
    })()
</script>


        </main>
    </div>
    <footer class="footer clearfix">
    <ul class="control social clearfix">
        <li><a class="author btn" href="#">Ziox</a></li>
        
        
        <li>
            <a class="icon-link btn" href="%20"><i class="icon behance"></i></a>
        </li>
        
        
        
        <li>
            <a class="icon-link btn" href="%20"><i class="icon email"></i></a>
        </li>
        
        
        
        <li>
            <a class="icon-link btn" href="%20"><i class="icon facebook"></i></a>
        </li>
        
        
        
        <li>
            <a class="icon-link btn" href="%20"><i class="icon github"></i></a>
        </li>
        
        
        
        <li>
            <a class="icon-link btn" href="%20"><i class="icon twitter"></i></a>
        </li>
        
        
        <li>
            <a class="icon-link btn" href="https://github.com/mjczz/sqldoc/index.xml" type="application/rss+xml" title="rss">
                <i class="rss icon"></i></a>
        </li>
    </ul>

    <ul class="control status clearfix">
        <li><a href="#" class="btn">Posts:
                2</a>
        </li>
        <li><a href="#" class="btn">Pages:
                0</a></li>
        <li><a href="#" class="btn">en</a></li>
        <li><a href="https://gohugo.io" class="btn">Hugo, 0.55.6</a></li>
        <li><a href="https://github.com/jacobsun/edidor" class="btn">主题: Edidor</a></li>
        <li>
            
                <a href="#" class="btn">Last build: <time
                    datetime="2019-05-18">2019-05-18</time>
                </a>
            
        </li>
    </ul>
</footer>
<div class="dialog">
    <div class="wrapper">
        <div class="clearfix"><button class="btn close-dialog">X</button></div>
        <header>
            <h1 class="title">Theme Name</h1>
        </header>
        <main>
            <div class="clearfix">
                <label for="theme-name">
                    <p>Only English Character, space, hyphen are allowed!</p>
                    <p>Valid name examples: "custom", "fantastic theme", "my-theme"</p>
                    <p>Invalid name examles: "我的主题", ":)", "123"</p>
                </label>
                <input type="text" name="theme-name" id="theme-name">
            </div>
            <div class="clearfix">
                <button class="btn export">Export</button>
            </div>

        </main>
        <footer></footer>
    </div>
</div>

    <script src="https://github.com/mjczz/sqldoc/js/main.js"></script>



<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'your ga id', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>

</html>
